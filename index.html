<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Finding Penguin ğŸ§ â€” A Love Story in the Snow</title>
<link rel="icon" type="image/png" href="favicon.png">
<link rel="apple-touch-icon" href="favicon.png">
<meta name="description" content="Finding Penguin â€” a charming 3D adventure game where Laila searches the endless snowfields to reunite with her lost penguin Waddler. Walk, explore, and find true love in the snow!">
<meta name="keywords" content="finding penguin, penguin game, cute game, adventure game, 3D browser game, HTML5 game, snow game, love story game, casual game, free online game, CrazyGames, puzzle game, family game">
<meta property="og:title" content="Finding Penguin ğŸ§ â€” A Love Story in the Snow">
<meta property="og:description" content="Help Laila find Waddler across the endless snowfields in this charming 3D adventure. Free to play in your browser!">
<meta property="og:image" content="logo.png">
<meta property="og:type" content="website">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="Finding Penguin ğŸ§">
<meta name="twitter:description" content="A charming 3D penguin love story. Find Waddler in the snow!">
<meta name="theme-color" content="#7aa8d8">
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{background:#b8d8f0;overflow:hidden;font-family:'Courier New',monospace;user-select:none;-webkit-user-select:none;}
canvas{display:block;}
#gc{position:fixed;inset:0;width:100%;height:100%;}

/* HUD */
#hud{position:fixed;top:0;left:0;right:0;padding:12px 16px;display:flex;justify-content:space-between;align-items:flex-start;pointer-events:none;z-index:10;}
#peng-btn{font-size:28px;cursor:pointer;pointer-events:all;filter:drop-shadow(0 2px 8px rgba(80,140,220,.6));transition:transform .15s;line-height:1;}
#peng-btn:hover{transform:scale(1.18);}
#hud-center{display:flex;flex-direction:column;align-items:center;gap:4px;}
#gtitle{color:#fff;font-size:13px;letter-spacing:4px;text-shadow:0 2px 10px rgba(60,120,220,.7);font-weight:bold;}
#gsubtitle{color:rgba(255,255,255,.7);font-size:9px;letter-spacing:2px;}
#hud-right{display:flex;align-items:center;gap:8px;}
#warmth{background:rgba(255,255,255,.18);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.35);border-radius:20px;padding:6px 14px;color:#fff;font-size:11px;letter-spacing:1px;}
#compass-box{background:rgba(255,255,255,.18);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.35);border-radius:50%;width:42px;height:42px;display:flex;align-items:center;justify-content:center;font-size:20px;}
#action-hint{position:fixed;bottom:14px;left:50%;transform:translateX(-50%);background:rgba(10,25,60,.45);backdrop-filter:blur(8px);border:1px solid rgba(255,255,255,.15);border-radius:24px;padding:6px 20px;color:rgba(255,255,255,.8);font-size:10px;letter-spacing:2px;pointer-events:none;z-index:10;transition:opacity .6s;opacity:0;}

/* SCREENS */
.fullscreen{position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:50;text-align:center;}

/* INTRO */
#intro-screen{background:linear-gradient(180deg,#7aa8d8 0%,#a8cef0 40%,#c8e8ff 70%,#e8f6ff 100%);}
#intro-canvas{position:absolute;inset:0;width:100%;height:100%;}
#intro-content{position:relative;z-index:2;display:flex;flex-direction:column;align-items:center;padding:24px;}
#ititle{font-size:clamp(32px,6vw,64px);color:#0d2550;letter-spacing:8px;font-weight:bold;text-shadow:0 3px 20px rgba(80,140,255,.4),0 1px 0 rgba(255,255,255,.3);margin-bottom:4px;}
#isub{font-size:clamp(11px,2.2vw,16px);color:#2a5898;letter-spacing:4px;margin-bottom:16px;opacity:.9;}
#istory-box{background:rgba(255,255,255,.25);backdrop-filter:blur(12px);border:1.5px solid rgba(255,255,255,.5);border-radius:16px;padding:20px 32px;max-width:460px;margin-bottom:36px;}
#istory{font-size:clamp(11px,1.8vw,15px);color:#1a3a70;letter-spacing:1.5px;line-height:2.2;text-align:center;}
#istory em{color:#0d2550;font-style:normal;font-weight:bold;}
.glassy-btn{background:rgba(255,255,255,.3);backdrop-filter:blur(14px);border:2px solid rgba(100,180,255,.6);color:#0d2550;font-family:'Courier New',monospace;font-size:14px;letter-spacing:5px;padding:14px 44px;cursor:pointer;border-radius:6px;text-transform:uppercase;transition:all .25s;box-shadow:0 4px 20px rgba(80,140,255,.2);}
.glassy-btn:hover{background:rgba(255,255,255,.55);transform:translateY(-3px);box-shadow:0 8px 30px rgba(80,140,255,.35);}

/* FOUND */
#found-screen{background:rgba(210,235,255,.97);display:none;}
#found-screen h2{font-size:34px;color:#0d2550;letter-spacing:6px;margin-bottom:12px;animation:hb .6s infinite alternate;}
#found-screen p{color:#2a5898;font-size:14px;letter-spacing:1.5px;margin-bottom:28px;line-height:2.2;}
.dark-btn{background:#1a3a6a;color:#fff;border:none;font-family:'Courier New',monospace;font-size:12px;letter-spacing:3px;padding:12px 36px;cursor:pointer;border-radius:4px;text-transform:uppercase;transition:background .2s;}
.dark-btn:hover{background:#2a5aaa;}

/* VISIT COUNTER */
#visit-badge{position:fixed;bottom:52px;left:12px;background:rgba(20,40,80,.72);backdrop-filter:blur(10px);border:1px solid rgba(100,160,255,.35);border-radius:16px;padding:5px 13px;color:#c8e4ff;font-size:10px;letter-spacing:1.5px;pointer-events:none;z-index:10;text-shadow:0 1px 4px rgba(0,0,80,.6);}
#intro-stats{margin-top:14px;color:rgba(140,200,255,.8);font-size:10px;letter-spacing:1.5px;}

/* INTRO BUTTON PULSE */
@keyframes btnpulse{0%,100%{box-shadow:0 4px 20px rgba(80,140,255,.2);}50%{box-shadow:0 4px 32px rgba(80,180,255,.55),0 0 0 4px rgba(100,180,255,.2);}}
.glassy-btn{animation:btnpulse 2s ease-in-out infinite;}

/* MAP OVERLAY */
#map-ov{position:fixed;inset:0;background:rgba(6,14,38,.92);display:none;align-items:center;justify-content:center;z-index:60;backdrop-filter:blur(6px);}
#map-box{background:rgba(210,230,255,.97);border:2px solid rgba(100,160,255,.45);border-radius:14px;padding:16px;display:flex;flex-direction:column;align-items:center;gap:10px;max-width:96vw;max-height:96vh;overflow-y:auto;}
#map-box h3{color:#0d2550;font-size:13px;letter-spacing:3px;}

/* Type picker â€” visual cards */
#type-picker{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;}
.type-card{background:rgba(255,255,255,.5);border:2px solid rgba(100,160,255,.25);border-radius:10px;padding:8px 10px;cursor:pointer;text-align:center;min-width:64px;transition:all .15s;}
.type-card:hover{background:rgba(255,255,255,.85);border-color:rgba(100,160,255,.7);}
.type-card.active{background:#fff;border-color:#3a8aff;box-shadow:0 2px 12px rgba(58,138,255,.25);}
.type-card-icon{font-size:22px;line-height:1;margin-bottom:3px;}
.type-card-label{font-size:8px;letter-spacing:1px;color:#3a5a9a;text-transform:uppercase;}

#map-cv{border:1px solid rgba(100,160,255,.3);border-radius:8px;cursor:crosshair;max-width:calc(96vw - 32px);max-height:50vh;}
#map-hint{font-size:9px;color:#4a6aaa;letter-spacing:1px;text-align:center;}

/* Quick-place form â€” shown inline below map */
#place-form{background:rgba(255,255,255,.8);border:1.5px solid rgba(100,160,255,.35);border-radius:10px;padding:14px 16px;width:100%;display:none;flex-direction:column;gap:10px;}
#place-form h4{color:#0d2550;font-size:11px;letter-spacing:2px;}
.pf-row{display:flex;gap:8px;}
.pf-inp{flex:1;border:1.5px solid #b0c8e8;border-radius:6px;padding:8px 10px;font-family:'Courier New',monospace;font-size:11px;color:#0d2550;outline:none;}
.pf-inp:focus{border-color:#4a8adf;}
.pf-btn{padding:8px 16px;font-family:'Courier New',monospace;font-size:10px;letter-spacing:2px;cursor:pointer;border-radius:6px;border:none;text-transform:uppercase;}
.pf-ok{background:#1a3a6a;color:#fff;}
.pf-cn{background:#eee;color:#666;}

/* POI TOOLTIP â€” floats above character in world-projected position */
#poi-tag{position:fixed;display:none;z-index:40;pointer-events:none;transition:opacity .18s;}
.poi-card{background:rgba(255,255,255,.97);border:2px solid rgba(100,160,255,.55);border-radius:18px;padding:16px 24px;backdrop-filter:blur(16px);box-shadow:0 12px 40px rgba(60,120,220,.28),0 2px 8px rgba(60,120,220,.14);text-align:center;min-width:160px;max-width:260px;position:relative;}
.poi-card::after{content:'';position:absolute;bottom:-11px;left:50%;transform:translateX(-50%);border:6px solid transparent;border-top-color:rgba(255,255,255,.97);}
.poi-card::before{content:'';position:absolute;bottom:-14px;left:50%;transform:translateX(-50%);border:7px solid transparent;border-top-color:rgba(100,160,255,.55);}
.pt-type-badge{font-size:9px;letter-spacing:2.5px;text-transform:uppercase;color:#8aaadd;margin-bottom:8px;font-weight:600;}
.pt-name{color:#0d2550;font-size:17px;letter-spacing:1px;font-weight:bold;margin-bottom:5px;line-height:1.2;}
.pt-url{color:#3a7aff;font-size:11px;text-decoration:none;cursor:pointer;pointer-events:all;display:none;letter-spacing:.5px;}
.pt-url:hover{text-decoration:underline;}

/* WADDLER SPEECH BUBBLE */
#waddler-msg{position:fixed;display:none;z-index:42;pointer-events:none;animation:wbob .8s ease-in-out infinite alternate;}
.waddler-bubble{background:rgba(255,240,255,.97);border:2.5px solid rgba(255,120,200,.6);border-radius:20px;padding:12px 20px;backdrop-filter:blur(12px);box-shadow:0 8px 32px rgba(255,80,180,.22);text-align:center;white-space:nowrap;position:relative;}
.waddler-bubble::after{content:'';position:absolute;bottom:-13px;left:50%;transform:translateX(-50%);border:7px solid transparent;border-top-color:rgba(255,240,255,.97);}
.waddler-bubble::before{content:'';position:absolute;bottom:-16px;left:50%;transform:translateX(-50%);border:8px solid transparent;border-top-color:rgba(255,120,200,.6);}
.wb-text{color:#880044;font-size:14px;font-weight:bold;letter-spacing:.5px;}
@keyframes wbob{from{transform:translateY(0)}to{transform:translateY(-6px)}}

/* REUNION HEARTS */
#reunion-hearts{position:fixed;inset:0;pointer-events:none;z-index:48;display:none;}
.heart-bubble{position:absolute;font-size:28px;animation:heartFloat 2.2s ease-out forwards;}
@keyframes heartFloat{0%{opacity:1;transform:translateY(0) scale(1)}70%{opacity:.8;transform:translateY(-80px) scale(1.3)}100%{opacity:0;transform:translateY(-140px) scale(.7)}}

/* ADMIN LOGIN */
#admin-login{position:fixed;inset:0;background:rgba(6,14,38,.88);display:none;align-items:center;justify-content:center;z-index:80;backdrop-filter:blur(8px);}
#al-box{background:#fff;border-radius:14px;padding:32px;width:300px;display:flex;flex-direction:column;gap:12px;text-align:center;}
#al-box h3{color:#0d2550;font-size:14px;letter-spacing:3px;}
#al-pw{border:1.5px solid #b0c8e8;border-radius:6px;padding:10px 12px;font-family:'Courier New',monospace;font-size:13px;color:#0d2550;outline:none;text-align:center;letter-spacing:4px;width:100%;}
#al-pw:focus{border-color:#4a8adf;}
#al-err{color:#cc4444;font-size:10px;letter-spacing:1px;min-height:14px;}
.al-row{display:flex;gap:8px;}
.al-btn{flex:1;padding:10px;font-family:'Courier New',monospace;font-size:10px;letter-spacing:2px;cursor:pointer;border-radius:6px;border:none;text-transform:uppercase;}
.ok{background:#1a3a6a;color:#fff;}.cn{background:#eee;color:#666;}

/* MOBILE */
#mob-ctrl{position:fixed;bottom:24px;left:50%;transform:translateX(-50%);display:none;z-index:20;}
.dp{display:grid;grid-template-columns:repeat(3,56px);grid-template-rows:repeat(3,56px);gap:4px;}
.db{background:rgba(255,255,255,.18);backdrop-filter:blur(10px);border:1.5px solid rgba(255,255,255,.4);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:22px;color:#fff;cursor:pointer;-webkit-tap-highlight-color:transparent;}
.db:active{background:rgba(255,255,255,.42);}
.de{background:transparent;border:none;}

@keyframes hb{from{transform:scale(1)}to{transform:scale(1.07)}}
@keyframes fadeUp{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
@media(max-width:640px){#mob-ctrl{display:block;}}
</style>
</head>
<body>
<canvas id="gc"></canvas>

<div id="hud">
  <img src="logo.png" id="hud-logo" alt="Finding Penguin" title="Double-click for map" style="height:36px;max-height:36px;filter:drop-shadow(0 2px 8px rgba(60,120,220,.5));cursor:pointer;pointer-events:all;display:block;">
  <div id="hud-center">
    <div id="gtitle">FINDING PENGUIN</div>
    <div id="gsubtitle">a love story in the snow</div>
  </div>
  <div id="hud-right">
    <div id="warmth">â„ï¸ Searching...</div>
    <div id="compass-box">â„</div>
  </div>
</div>
<div id="action-hint">JÂ·jump &nbsp;Â·&nbsp; CÂ·spin &nbsp;Â·&nbsp; HÂ·wave &nbsp;Â·&nbsp; BÂ·bow</div>
<div id="visit-badge" title="Your visits Â· Players online now">ğŸ‘£ <span id="visit-count">â€¦</span> &nbsp;Â·&nbsp; ğŸ§ <span id="online-count">â€¦</span></div>

<!-- INTRO -->
<div class="fullscreen" id="intro-screen">
  <canvas id="intro-canvas"></canvas>
  <div id="intro-content">
    <div id="ititle">FINDING PENGUIN</div>
    <div id="isub">a love story in the snow</div>
    <div id="istory-box">
      <div id="istory">
        <em>Waddler</em> wandered off into the endless snowfields,<br>
        curious and carefree... further and further...<br>
        until the white swallowed him whole.<br><br>
        Now <em>Laila</em> sets off across the frozen world<br>
        to find her mate and bring him home.
      </div>
    </div>
    <button class="glassy-btn" onclick="startGame()">â–¶ &nbsp;BEGIN THE SEARCH</button>
    <div style="color:rgba(100,180,255,.8);font-size:10px;letter-spacing:2px;margin-top:10px;text-align:center;">â†‘ click anytime to begin</div>
    <div id="intro-stats">ğŸ‘£ <span id="intro-visit-count">â€¦</span> adventures &nbsp;Â·&nbsp; ğŸ§ <span id="intro-online-count">â€¦</span> exploring now</div>
  </div>
</div>

<!-- FOUND -->
<div class="fullscreen" id="found-screen">
  <h2 style="margin-bottom:12px">Selfie time! ğŸ“¸</h2>
  <canvas id="portrait-canvas" style="border-radius:16px;box-shadow:0 8px 40px rgba(60,120,220,.4);max-width:min(320px,80vw);max-height:min(320px,45vh);margin-bottom:18px;display:block;"></canvas>
  <p id="found-msg">Laila found Waddler! ğŸ’™</p>
  <div style="display:flex;gap:12px;flex-wrap:wrap;justify-content:center;margin-bottom:8px;">
    <button class="dark-btn" id="share-btn" onclick="sharePortrait()">ğŸ“¸ &nbsp;Share on Instagram</button>
    <button class="dark-btn" onclick="nextRound()" style="background:#1a5a2a;">â–¶ &nbsp;Wander Again</button>
  </div>
</div>

<!-- MAP / ADMIN OVERLAY -->
<div id="map-ov" onclick="if(event.target===this)closeMap()">
  <div id="map-box">
    <h3>ğŸ—º &nbsp;THE SNOWFIELDS</h3>

    <!-- Type picker â€” only visible when admin unlocked -->
    <div id="type-picker" style="display:none">
      <div class="type-card active" data-type="none" onclick="pickType('none',this)">
        <div class="type-card-icon">ğŸ‘</div>
        <div class="type-card-label">View</div>
      </div>
      <div class="type-card" data-type="person" onclick="pickType('person',this)">
        <div class="type-card-icon">ğŸ§</div>
        <div class="type-card-label">Person</div>
      </div>
      <div class="type-card" data-type="shop" onclick="pickType('shop',this)">
        <div class="type-card-icon">ğŸª</div>
        <div class="type-card-label">Shop</div>
      </div>
      <div class="type-card" data-type="store" onclick="pickType('store',this)">
        <div class="type-card-icon">ğŸ¬</div>
        <div class="type-card-label">Store</div>
      </div>
      <div class="type-card" data-type="stall" onclick="pickType('stall',this)">
        <div class="type-card-icon">ğŸª</div>
        <div class="type-card-label">Stall</div>
      </div>
      <div class="type-card" data-type="land" onclick="pickType('land',this)">
        <div class="type-card-icon">ğŸ”</div>
        <div class="type-card-label">Landmark</div>
      </div>
    </div>

    <canvas id="map-cv" width="480" height="480"></canvas>
    <div id="map-hint">Double-click ğŸ§ to open map</div>

    <!-- Inline place form â€” appears after clicking map -->
    <div id="place-form">
      <h4 id="pf-title">ADD PLACE</h4>
      <div class="pf-row">
        <input class="pf-inp" id="pf-name" placeholder="Name (e.g. Igloo CafÃ©)">
      </div>
      <div class="pf-row">
        <input class="pf-inp" id="pf-url" placeholder="Website (optional)">
      </div>
      <div class="pf-row">
        <button class="pf-btn pf-ok" onclick="confirmPlace()">âœ“ PLACE IT</button>
        <button class="pf-btn pf-cn" onclick="cancelPlace()">âœ• Cancel</button>
      </div>
    </div>

    <div style="display:flex;gap:8px;">
      <button class="dark-btn" onclick="closeMap()">âœ• CLOSE</button>
      <button class="dark-btn" id="admin-btn" style="background:#2a5a2a" onclick="promptAdmin()">ğŸ” ADMIN</button>
    </div>
  </div>
</div>

<!-- POI TOOLTIP -->
<div id="poi-tag">
  <div class="poi-card">
    <div class="pt-type-badge" id="pt-type"></div>
    <div class="pt-name" id="pt-name"></div>
    <a class="pt-url" id="pt-url" href="#" target="_blank" rel="noopener" onclick="return openPoiLink(event)"></a>
  </div>
</div>

<!-- WADDLER SPEECH BUBBLE -->
<div id="waddler-msg">
  <div class="waddler-bubble">
    <div class="wb-text" id="wb-text">Hey Laila!! You found me!! ğŸ’™</div>
  </div>
</div>

<!-- REUNION HEARTS OVERLAY -->
<div id="reunion-hearts"></div>

<!-- ADMIN LOGIN -->
<div id="admin-login">
  <div id="al-box">
    <div style="font-size:40px">ğŸ”</div>
    <h3>ADMIN ACCESS</h3>
    <input type="password" id="al-pw" placeholder="password" maxlength="32"
      onkeydown="if(event.key==='Enter')tryLogin()"/>
    <div id="al-err"></div>
    <div class="al-row">
      <button class="al-btn ok" onclick="tryLogin()">âœ“ LOGIN</button>
      <button class="al-btn cn" onclick="document.getElementById('admin-login').style.display='none'">âœ•</button>
    </div>
  </div>
</div>

<!-- Mobile D-pad -->
<div id="mob-ctrl">
  <div class="dp">
    <div class="de"></div><div class="db" id="mbu">â–²</div><div class="de"></div>
    <div class="db" id="mbl">â—€</div><div class="de"></div><div class="db" id="mbr">â–¶</div>
    <div class="de"></div><div class="db" id="mbd">â–¼</div><div class="de"></div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://sdk.crazygames.com/crazygames-sdk-v3.js"></script>
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VISIT COUNTER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(function(){
  try{
    const k='fp_visits';
    const n=(parseInt(localStorage.getItem(k)||'0')+1);
    localStorage.setItem(k,String(n));
    const s=n.toLocaleString();
    const el=document.getElementById('visit-count');if(el)el.textContent=s;
    const el2=document.getElementById('intro-visit-count');if(el2)el2.textContent=s;
  }catch(e){}
})();

// â”€â”€ Online presence (Cloudflare Worker) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(function(){
  const sid='fp_'+Math.random().toString(36).slice(2,10);
  const DEFAULT_WORKER='https://finding-penguin-worker.domain-sparrow.workers.dev';
  function workerUrl(){try{const d=localStorage.getItem('fp_settings');if(d){const s=JSON.parse(d);if(s.workerUrl)return s.workerUrl.trim();}}catch(e){}return DEFAULT_WORKER;}
  function pingSession(){
    const u=workerUrl();if(!u)return;
    fetch(u+'/session',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({sid})}).catch(()=>{});
  }
  function fetchOnline(){
    const u=workerUrl();if(!u)return;
    fetch(u+'/sessions').then(r=>r.json()).then(d=>{
      if(typeof d.count==='number'){
        const c=d.count;
        const el=document.getElementById('online-count');if(el)el.textContent=c;
        const el2=document.getElementById('intro-online-count');if(el2)el2.textContent=c;
      }
    }).catch(()=>{});
  }
  // Ping immediately + every 15s; fetch count every 20s
  pingSession();fetchOnline();
  setInterval(pingSession,15000);
  setInterval(fetchOnline,20000);
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INTRO 2D ANIMATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const IC=document.getElementById('intro-canvas'),IX=IC.getContext('2d');
let IW,IH,IF=0,introAlive=true;
const IP={x:-80,y:0,step:0,t:0,alpha:1};
const IFP=[];let IPhase='walk';
function rsI(){IW=IC.width=window.innerWidth;IH=IC.height=window.innerHeight;}rsI();

function drawIP(ctx,x,y,st,al,sc){
  ctx.save();ctx.globalAlpha=Math.max(0,al);ctx.translate(x,y);ctx.scale(sc,sc);
  const b=st%2?-3:0,lg=st%2?4:-4;
  ctx.fillStyle='rgba(60,100,180,.12)';ctx.beginPath();ctx.ellipse(0,22,18,6,0,0,Math.PI*2);ctx.fill();
  ctx.fillStyle='#111128';ctx.beginPath();ctx.ellipse(0,2+b,12,16,0,0,Math.PI*2);ctx.fill();
  ctx.fillStyle='#f0f2f8';ctx.beginPath();ctx.ellipse(0,4+b,8,11,0,0,Math.PI*2);ctx.fill();
  ctx.fillStyle='#111128';ctx.beginPath();ctx.arc(0,-16+b,12,0,Math.PI*2);ctx.fill();
  ctx.fillStyle='#fff';ctx.beginPath();ctx.arc(5,-18+b,4,0,Math.PI*2);ctx.fill();
  ctx.fillStyle='#000';ctx.beginPath();ctx.arc(6.5,-18+b,2.2,0,Math.PI*2);ctx.fill();
  ctx.fillStyle='#f0a020';ctx.beginPath();ctx.moveTo(9,-16+b);ctx.lineTo(17,-14+b);ctx.lineTo(9,-12+b);ctx.closePath();ctx.fill();
  ctx.fillStyle='#111128';
  ctx.beginPath();ctx.ellipse(-14,-2+b,5,10,-.3,0,Math.PI*2);ctx.fill();
  ctx.beginPath();ctx.ellipse(14,-2+b+lg*.3,5,10,.3,0,Math.PI*2);ctx.fill();
  ctx.fillStyle='#f0a020';
  ctx.beginPath();ctx.ellipse(-5,18+b,6,3,.3,0,Math.PI*2);ctx.fill();
  ctx.beginPath();ctx.ellipse(5,18+b+lg*.3,6,3,-.3,0,Math.PI*2);ctx.fill();
  ctx.restore();
}

function introLoop(){
  if(!introAlive)return;
  IX.clearRect(0,0,IW,IH);
  const gy=IH*.62+50;
  const sg=IX.createLinearGradient(0,0,0,IH);
  sg.addColorStop(0,'#7aa8d8');sg.addColorStop(.5,'#b0d0f0');sg.addColorStop(1,'#e0f0ff');
  IX.fillStyle=sg;IX.fillRect(0,0,IW,IH);
  IX.fillStyle='#c8e4f8';IX.beginPath();IX.moveTo(0,gy-40);
  for(let x=0;x<=IW;x+=60)IX.lineTo(x,gy-40+Math.sin(x*.015)*28+Math.sin(x*.035)*12);
  IX.lineTo(IW,IH);IX.lineTo(0,IH);IX.closePath();IX.fill();
  IX.fillStyle='#eaf6ff';IX.beginPath();IX.moveTo(0,gy+20);
  for(let x=0;x<=IW;x+=40)IX.lineTo(x,gy+20+Math.sin(x*.022+1)*12);
  IX.lineTo(IW,IH);IX.lineTo(0,IH);IX.closePath();IX.fill();
  IX.fillStyle='rgba(255,255,255,.75)';
  for(let i=0;i<80;i++){const x=(i*137.5+IF*.28*(i%3+.4))%IW,y=(i*71+IF*.82*(i%2+.5))%IH,s=.8+i%4*.7;IX.beginPath();IX.arc(x,y,s,0,Math.PI*2);IX.fill();}
  IX.fillStyle='rgba(100,150,200,.22)';
  for(const f of IFP){IX.beginPath();IX.ellipse(f.x,f.y,5,3,.3,0,Math.PI*2);IX.fill();IX.beginPath();IX.ellipse(f.x+12,f.y+3,5,3,-.3,0,Math.PI*2);IX.fill();}
  if(IPhase==='walk'){IP.x+=1.4;IP.t+=16;if(IP.t>200){IP.step=(IP.step+1)%4;IP.t=0;if(IFP.length<40)IFP.push({x:IP.x-16,y:gy+10});}if(IP.x>IW*.62)IPhase='fade';}
  else if(IPhase==='fade'){IP.x+=1.7;IP.alpha-=.006;IP.t+=16;if(IP.t>200){IP.step=(IP.step+1)%4;IP.t=0;}if(IP.alpha<=0){IPhase='done';IP.alpha=0;}}
  const ta=Math.min(1,IF/90);
  IX.globalAlpha=ta*.9;IX.fillStyle='#2a5088';
  IX.font=`italic ${Math.round(Math.max(13,IW*.016))}px Georgia,serif`;
  IX.textAlign='center';
  IX.fillText(IP.alpha>.35?'"Waddler wandered into the endless snowfields..."':'"...and disappeared into the white."',IW/2,IH*.88);
  // Mirror horizontally so penguin faces LEFT (toward viewer, like Waddler in-game)
  IX.globalAlpha=1;
  IX.save();IX.translate(IP.x,gy);IX.scale(-1,1);drawIP(IX,0,0,IP.step,IP.alpha,1.5);IX.restore();
  IF++;requestAnimationFrame(introLoop);
}
requestAnimationFrame(introLoop);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUDIO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let ACX=null;
function initAudio(){if(!ACX)try{ACX=new(window.AudioContext||window.webkitAudioContext)();}catch(e){}}
function beep(freq,dur,type,vol){
  if(!ACX)return;try{
    const o=ACX.createOscillator(),g=ACX.createGain();
    o.connect(g);g.connect(ACX.destination);
    o.frequency.value=freq;o.type=type||'triangle';
    g.gain.setValueAtTime(vol||.1,ACX.currentTime);
    g.gain.exponentialRampToValueAtTime(.001,ACX.currentTime+dur);
    o.start();o.stop(ACX.currentTime+dur);}catch(e){}
}
function sStep(){beep(100+Math.random()*20,.06,'triangle',.03);}
function sFound(){[523,659,784,1047,1319].forEach((f,i)=>setTimeout(()=>beep(f,.28,'triangle',.18),i*115));}
function sJump(){beep(380,.04,'sine',.12);setTimeout(()=>beep(480,.14,'sine',.07),55);}
function sWave(){[290,380,330].forEach((f,i)=>setTimeout(()=>beep(f,.07,'triangle',.06),i*75));}
function sWaddle(){beep(85+Math.random()*20,.1,'triangle',.04);}
let pingLast=0;
function sPing(r){const now=Date.now(),iv=Math.max(140,3000-r*2900);if(now-pingLast>iv&&r>.06){beep(350+r*500,.09,'sine',.1*r);pingLast=now;}}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// THREE.JS GAME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let scene,camera,renderer,gameRunning=false,round=1;
const WRAD=700,BSIZ=4;

function terrainH(px,pz){
  return Math.sin(px*.012)*4+Math.cos(pz*.010)*3.5+Math.sin(px*.025+pz*.02)*1.8+Math.sin(px*.006-pz*.007)*6;
}

const PS=0.65; // player penguin scale
const CS=1.0;  // POI character scale

// Laila
let lailaGroup=null,lWL,lWR,lFL,lFR,lHead,lBodyMesh;
const lPos=new THREE.Vector3();
let lYaw=0,lAnimT=0,lStep=0;
let lState='idle',prevState='idle',stateT=0;
let idleT=0,waddleNext=5000+Math.random()*6000,waddleT=0,circleYaw=0;

// Waddler
let waddlerGroup=null,wWL,wWR,wFL,wFR;
const wPos=new THREE.Vector3();
let wYaw=0,wVX=0,wVZ=0,wTimer=0,wAnimT=0,wStep=0;

// Camera
let camYaw=0;
const CAM_D=14,CAM_H=8;

// Input
const K={};
let TD={x:0,z:0};

// POIs â€” persisted to localStorage
let POIS=[];
let pendPoi=null,nearPoi=null,activePoi=null;
let mapTool='none';
const ADMIN_PW='penguin2024';
let adminOK=false;

// Materials
let M={};

// â”€â”€ Resize â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function onResize(){
  if(!camera||!renderer)return;
  camera.aspect=window.innerWidth/window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth,window.innerHeight);
}
window.addEventListener('resize',()=>{rsI();onResize();});

// â”€â”€ Init Three â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initThree(){
  scene=new THREE.Scene();
  scene.background=new THREE.Color(0xb0d4f0);
  scene.fog=new THREE.FogExp2(0xc0dcf4,.0007);
  camera=new THREE.PerspectiveCamera(62,window.innerWidth/window.innerHeight,.5,1400);
  renderer=new THREE.WebGLRenderer({canvas:document.getElementById('gc'),antialias:false,preserveDrawingBuffer:true});
  renderer.setSize(window.innerWidth,window.innerHeight);
  renderer.setPixelRatio(Math.min(window.devicePixelRatio,1.5));
  renderer.shadowMap.enabled=true;
  renderer.shadowMap.type=THREE.PCFShadowMap; // cheaper than PCFSoft
  const amb=new THREE.AmbientLight(0xd0e8ff,.95);scene.add(amb);
  const sun=new THREE.DirectionalLight(0xfff8f0,1.2);
  sun.position.set(200,350,150);sun.castShadow=true;
  sun.shadow.camera.near=1;sun.shadow.camera.far=1600;
  sun.shadow.camera.left=sun.shadow.camera.bottom=-600;
  sun.shadow.camera.right=sun.shadow.camera.top=600;
  sun.shadow.mapSize.set(1024,1024);scene.add(sun);
  const fill=new THREE.DirectionalLight(0xb0d0ff,.4);fill.position.set(-100,60,-80);scene.add(fill);
}

// â”€â”€ Materials â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildMats(){
  M={
    snow: new THREE.MeshLambertMaterial({color:0xeef6ff}),
    snowT:new THREE.MeshLambertMaterial({color:0xffffff}),
    ice:  new THREE.MeshLambertMaterial({color:0xaaddf8,transparent:true,opacity:.82}),
    rock: new THREE.MeshLambertMaterial({color:0x9aabbc}),
    gnd:  new THREE.MeshLambertMaterial({color:0xf2f9ff}),
    // penguin core
    pB:   new THREE.MeshLambertMaterial({color:0x111128}),
    pW:   new THREE.MeshLambertMaterial({color:0xf0f2f8}),
    pO:   new THREE.MeshLambertMaterial({color:0xf0a020}),
    pE:   new THREE.MeshLambertMaterial({color:0xffffff}),
    pP:   new THREE.MeshLambertMaterial({color:0x050510}),
    pole: new THREE.MeshLambertMaterial({color:0xddeebb}),
    // penguin variant accessories
    vHat: new THREE.MeshLambertMaterial({color:0xcc2222}), // red hat
    vShd: new THREE.MeshLambertMaterial({color:0x2244bb,transparent:true,opacity:.88}), // blue shades
    vDck: new THREE.MeshLambertMaterial({color:0xdd8833}), // skate deck
    vWhl: new THREE.MeshLambertMaterial({color:0x222222}), // skate wheels
    vScf: new THREE.MeshLambertMaterial({color:0xee4488}), // pink scarf
    vBow: new THREE.MeshLambertMaterial({color:0xff77bb}), // pink bow
    vBwK:new THREE.MeshLambertMaterial({color:0xff44aa}),  // bow knot (darker)
    // seal
    slBd: new THREE.MeshLambertMaterial({color:0x8b5a2b}), // seal body (warm brown)
    slBl: new THREE.MeshLambertMaterial({color:0x4a3018}), // seal dark brown
    slEy: new THREE.MeshLambertMaterial({color:0x111111}), // seal eye
    slEW: new THREE.MeshLambertMaterial({color:0xffffff}), // seal eye white
    slSn: new THREE.MeshLambertMaterial({color:0x4a3018}), // seal snout
    // polar bear
    pbWh: new THREE.MeshLambertMaterial({color:0xffffff}), // polar bear white
    pbBk: new THREE.MeshLambertMaterial({color:0x111111}), // polar bear black (nose/eyes)
    // building
    bRoof:new THREE.MeshLambertMaterial({color:0xdd4422}),
    bWall:new THREE.MeshLambertMaterial({color:0xffe8cc}),
    bSign:new THREE.MeshLambertMaterial({color:0xffdd44}),
    bFrm: new THREE.MeshLambertMaterial({color:0x8899aa}),
    bGls: new THREE.MeshLambertMaterial({color:0xaaddff,transparent:true,opacity:.6}),
    bMat: new THREE.MeshLambertMaterial({color:0xcc3344}),
    bPol: new THREE.MeshLambertMaterial({color:0xeeaa22}),
  };
}

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// addBox adds to a target group/scene; terrainGroup used during buildWorld
let _terrainGroup=null;
function addBox(x,y,z,w,h,d,mat){
  const target=_terrainGroup||scene;
  const m=new THREE.Mesh(new THREE.BoxGeometry(w,h,d),mat);
  m.position.set(x,y,z);m.castShadow=true;m.receiveShadow=true;target.add(m);return m;
}

// â”€â”€ World â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildWorld(){
  const rm=[];scene.children.forEach(o=>{if(!o.isLight)rm.push(o);});rm.forEach(o=>scene.remove(o));
  _sfPoints=null;_sfArr=null;
  buildMats();
  // Ground â€” reduced subdivision for performance (120Ã—120 vs 180Ã—180)
  const GS=WRAD*2.5,gGeo=new THREE.PlaneGeometry(GS,GS,120,120),gP=gGeo.attributes.position;
  for(let i=0;i<gP.count;i++){const px=gP.getX(i),py=gP.getY(i);gP.setZ(i,terrainH(px,-py));}
  gP.needsUpdate=true;gGeo.computeVertexNormals();
  const gnd=new THREE.Mesh(gGeo,M.gnd);gnd.rotation.x=-Math.PI/2;gnd.receiveShadow=true;gnd.name='ground';scene.add(gnd);
  // Terrain objects â€” all in one Group (single scene-graph node)
  _terrainGroup=new THREE.Group();scene.add(_terrainGroup);
  const seed=Math.random()*9999;
  function rn(x,z,s){const v=Math.sin(x*127.1+z*311.7+s*74.3)*43758;return v-Math.floor(v);}
  const CSTEP=Math.max(2,Math.min(8,loadSettings().terrainDensity||4)),CHK=Math.floor(WRAD/BSIZ/CSTEP);
  for(let bx=-CHK;bx<CHK;bx++){
    for(let bz=-CHK;bz<CHK;bz++){
      const n=rn(bx,bz,seed),n2=rn(bx,bz,seed+1),n3=rn(bx,bz,seed+2);
      const wx=(bx+(n-.5)*2)*BSIZ*CSTEP,wz=(bz+(n2-.5)*2)*BSIZ*CSTEP;
      if(Math.hypot(wx,wz)<25)continue;
      const gy=terrainH(wx,wz);
      if(n<.008){const h=1.5+n2*2.5;addBox(wx,gy+h/2,wz,BSIZ*.5,h,BSIZ*.5,M.ice);}
      else if(n<.14){const layers=Math.floor(1+n2*4);for(let l=0;l<layers;l++){const sz=BSIZ*(1-l*.18),bh=BSIZ*.55;addBox(wx,gy+bh*.5+l*bh*.85,wz,sz,bh,sz,l===layers-1?M.snowT:M.snow);}}
      else if(n<.23){const cnt=1+Math.floor(n3*3);for(let i=0;i<cnt;i++){const ox=(n3*i-.5)*BSIZ*.9,oz=(n2*i-.5)*BSIZ*.9,rh=BSIZ*(.3+n3*.5);addBox(wx+ox,gy+rh/2,wz+oz,BSIZ*(.5+n3*.35),rh,BSIZ*(.5+n2*.35),M.rock);}}
    }
  }
  _terrainGroup=null; // done building terrain
  // Snowfall
  const N=2000,sfArr=new Float32Array(N*3);
  for(let i=0;i<N;i++){sfArr[i*3]=(Math.random()-.5)*500;sfArr[i*3+1]=Math.random()*60;sfArr[i*3+2]=(Math.random()-.5)*500;}
  const sfGeo=new THREE.BufferGeometry();
  sfGeo.setAttribute('position',new THREE.BufferAttribute(sfArr,3));
  const sf=new THREE.Points(sfGeo,new THREE.PointsMaterial({color:0xffffff,size:.3,transparent:true,opacity:.72,depthWrite:false}));
  sf.name='snowfall';scene.add(sf);
  _sfPoints=sf;_sfArr=sfArr; // cache for tickSnow
  // POIs
  POIS.forEach(p=>makePOIMesh(p));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PENGUIN BUILDER â€” base + variants
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// variant: null (plain) | 'hat' | 'shades' | 'scarf' | 'skate'
function buildPenguinGroup(scale, variant, refs){
  const g=new THREE.Group();
  const S=scale;
  function bx(w,h,d,mat,px,py,pz){
    const m=new THREE.Mesh(new THREE.BoxGeometry(w*S,h*S,d*S),mat);
    m.position.set(px*S,py*S,pz*S);m.castShadow=true;g.add(m);return m;
  }
  // body
  const body=bx(1.9,2.4,1.7,M.pB,0,1.2,0);
  // belly
  bx(1.26,1.72,.28,M.pW,0,1.1,.86);
  // head
  const head=bx(1.65,1.55,1.55,M.pB,0,2.82,0);
  // eyes
  bx(.28,.28,.1,M.pE,-.42,2.92,.78);bx(.28,.28,.1,M.pE,.42,2.92,.78);
  bx(.16,.16,.06,M.pP,-.42,2.92,.83);bx(.16,.16,.06,M.pP,.42,2.92,.83);
  // beak
  bx(.5,.32,.55,M.pO,0,2.66,1.0);
  // wings
  const wL=bx(.48,1.65,.62,M.pB,-1.18,1.2,0);
  const wR=bx(.48,1.65,.62,M.pB,1.18,1.2,0);
  // feet
  const fL=bx(.72,.22,.95,M.pO,-.5,.12,.28);
  const fR=bx(.72,.22,.95,M.pO,.5,.12,.28);

  // Accessories
  if(variant==='hat'){
    bx(1.5,.14,1.5,M.vHat,0,3.62,0); // brim
    bx(.9,.7,.9,M.vHat,0,4.05,0);    // crown
  } else if(variant==='shades'){
    const lns=new THREE.Mesh(new THREE.BoxGeometry(.32*S,.2*S,.08*S),M.vShd);lns.position.set(-.38*S,2.9*S,.83*S);g.add(lns);
    const rns=new THREE.Mesh(new THREE.BoxGeometry(.32*S,.2*S,.08*S),M.vShd);rns.position.set(.38*S,2.9*S,.83*S);g.add(rns);
    const br=new THREE.Mesh(new THREE.BoxGeometry(.82*S,.08*S,.06*S),M.vShd);br.position.set(0,2.9*S,.83*S);g.add(br);
  } else if(variant==='scarf'){
    bx(1.7,.4,1.7,M.vScf,0,2.1,0); // scarf ring around neck
  } else if(variant==='skate'){
    // deck
    const dk=new THREE.Mesh(new THREE.BoxGeometry(1.1*S,.12*S,2.2*S),M.vDck);dk.position.set(0,-.1*S,.2*S);dk.castShadow=true;g.add(dk);
    // wheels
    [[-0.4,-.22,-.7],[0.4,-.22,-.7],[-0.4,-.22,.9],[0.4,-.22,.9]].forEach(([wx,wy,wz])=>{
      const w=new THREE.Mesh(new THREE.CylinderGeometry(.16*S,.16*S,.14*S,6),M.vWhl);
      w.rotation.z=Math.PI/2;w.position.set(wx*S,wy*S,wz*S);w.castShadow=true;g.add(w);
    });
  } else if(variant==='bow'){
    // Pink bow on top-right of head â€” left loop, right loop, knot
    const bl=new THREE.Mesh(new THREE.BoxGeometry(.42*S,.3*S,.12*S),M.vBow);
    bl.position.set(-.26*S,3.74*S,.05*S);bl.rotation.z=.42;g.add(bl);
    const br=new THREE.Mesh(new THREE.BoxGeometry(.42*S,.3*S,.12*S),M.vBow);
    br.position.set(.26*S,3.74*S,.05*S);br.rotation.z=-.42;g.add(br);
    const bk=new THREE.Mesh(new THREE.BoxGeometry(.18*S,.18*S,.14*S),M.vBwK);
    bk.position.set(0,3.74*S,.05*S);g.add(bk);
  }

  if(refs){refs.wL=wL;refs.wR=wR;refs.fL=fL;refs.fR=fR;refs.head=head;refs.body=body;}
  return g;
}

// â”€â”€ Player & Waddler â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function makePenguin(isW){
  if(isW){
    const g=buildPenguinGroup(PS,null,null);
    // store waddler refs manually since we can't pass refs obj easily inline
    const ch=g.children;
    wWL=ch[7];wWR=ch[8];wFL=ch[9];wFR=ch[10];
    return g;
  } else {
    const refs={};
    const g=buildPenguinGroup(PS,null,refs);
    lWL=refs.wL;lWR=refs.wR;lFL=refs.fL;lFR=refs.fR;lHead=refs.head;lBodyMesh=refs.body;
    return g;
  }
}

// â”€â”€ POI 3D Models â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function makePOIMesh(poi){
  // Clean up old meshes
  if(poi.group){scene.remove(poi.group);poi.group=null;}

  // Hidden POIs are removed from the world entirely
  if(poi.visible===false)return;

  const g=new THREE.Group();
  const gy=terrainH(poi.x,poi.z);
  const S=CS;
  const type=poi.type||'shop';

  if(type==='person'){
    // Person = penguin with a variant prop (round-robin through variants)
    const variants=['hat','shades','scarf','skate'];
    const variant=variants[(poi._variantIdx||0)%variants.length];
    buildPenguinGroup(S*1.15, variant, null).children.forEach(c=>{g.add(c);});
    g.rotation.y=Math.PI*0.25;
  } else if(type==='shop'){
    makeShop3D(g,S);
  } else if(type==='store'){
    makeStore3D(g,S);
  } else if(type==='stall'){
    makeStall3D(g,S);
  } else if(type==='land'){
    makeLandmark3D(g,S);
  } else if(type==='seal'){
    makeSeal3D(g,S);
    g.rotation.y=Math.PI*0.15;
  } else if(type==='polarbear'){
    makePolarBear3D(g,S);
    g.rotation.y=-Math.PI*0.2;
  } else {
    makeGenericPost(g,S);
  }

  g.position.set(poi.x,gy,poi.z);
  g.userData.poiId=poi.id;
  scene.add(g);
  poi.group=g;
}

function makeShop3D(g,S){
  function b(w,h,d,mat,px,py,pz){const m=new THREE.Mesh(new THREE.BoxGeometry(w*S,h*S,d*S),mat);m.position.set(px*S,py*S,pz*S);m.castShadow=true;g.add(m);}
  b(3.2,.25,2.6,M.rock,0,.12,0);    // base
  b(3.2,2.5,2.6,M.bWall,0,1.5,0);   // walls
  b(.7,1.4,.12,M.pB,0,.7,1.31);     // door
  b(.7,.7,.1,M.bGls,-.9,1.6,1.31);  // window L
  b(.7,.7,.1,M.bGls,.9,1.6,1.31);   // window R
  b(3.6,.55,3.0,M.bRoof,0,2.85,0);  // roof base
  b(2.8,.4,1.0,M.bRoof,0,3.2,0);    // roof peak
  b(1.8,.45,.1,M.bSign,0,2.2,1.32); // sign
}

function makeStore3D(g,S){
  function b(w,h,d,mat,px,py,pz){const m=new THREE.Mesh(new THREE.BoxGeometry(w*S,h*S,d*S),mat);m.position.set(px*S,py*S,pz*S);m.castShadow=true;g.add(m);}
  b(4.5,.25,3.2,M.rock,0,.12,0);
  b(4.5,3.0,3.2,M.bWall,0,1.75,0);
  b(3.5,2.0,.1,M.bGls,0,1.2,1.61);  // glass front
  b(1.0,2.2,.14,M.bFrm,0,1.1,1.61); // door frame
  b(5.0,.3,3.8,M.bFrm,0,3.25,0);    // flat roof
  b(4.5,.55,.14,M.bSign,0,3.05,1.62);// sign strip
  b(.3,3.0,.3,M.bFrm,-2.05,1.5,1.6);// pillars
  b(.3,3.0,.3,M.bFrm,2.05,1.5,1.6);
}

function makeStall3D(g,S){
  function b(w,h,d,mat,px,py,pz){const m=new THREE.Mesh(new THREE.BoxGeometry(w*S,h*S,d*S),mat);m.position.set(px*S,py*S,pz*S);m.castShadow=true;g.add(m);}
  function cyl(px,pz){const m=new THREE.Mesh(new THREE.CylinderGeometry(.12*S,.12*S,2.5*S,6),M.bPol);m.position.set(px*S,1.25*S,pz*S);m.castShadow=true;g.add(m);}
  cyl(-1.4,-1.0);cyl(1.4,-1.0);cyl(-1.4,1.0);cyl(1.4,1.0);
  b(3.2,.16,2.6,M.bMat,0,2.6,0);   // canopy
  b(3.0,.25,1.2,M.bWall,0,1.0,0);  // counter top
  b(3.0,.8,1.2,M.bSign,0,.55,0);   // counter body
  // display items
  b(.4,.4,.4,M.bRoof,-.8,1.25,.1);
  b(.4,.4,.4,M.snow,0,1.25,.1);
  b(.4,.4,.4,M.pO,.8,1.25,.1);
}

function makeLandmark3D(g,S){
  function b(w,h,d,mat,px,py,pz){const m=new THREE.Mesh(new THREE.BoxGeometry(w*S,h*S,d*S),mat);m.position.set(px*S,py*S,pz*S);m.castShadow=true;g.add(m);}
  b(2.0,.4,2.0,M.rock,0,.2,0);
  b(1.6,1.0,1.6,M.rock,0,.9,0);
  b(1.2,1.0,1.2,M.snow,0,1.8,0);
  b(.8,1.0,.8,M.snowT,0,2.6,0);
  b(.4,.8,.4,M.ice,0,3.2,0);
}

function makeGenericPost(g,S){
  function b(w,h,d,mat,px,py,pz){const m=new THREE.Mesh(new THREE.BoxGeometry(w*S,h*S,d*S),mat);m.position.set(px*S,py*S,pz*S);m.castShadow=true;g.add(m);}
  const pole=new THREE.Mesh(new THREE.CylinderGeometry(.1*S,.1*S,3.5*S,6),M.pole);
  pole.position.set(0,1.75*S,0);pole.castShadow=true;g.add(pole);
  b(1.8,1.8,.12,M.bSign,0,4.0,0); // sign board
}

function makeSeal3D(g,S){
  // Brown seal lying down â€” warm brown color scheme
  function b(w,h,d,mat,px,py,pz){const m=new THREE.Mesh(new THREE.BoxGeometry(w*S,h*S,d*S),mat);m.position.set(px*S,py*S,pz*S);m.castShadow=true;g.add(m);}
  // Main body (lying down)
  b(1.6,1.0,2.2,M.slBd, 0,0.5,0);
  // Head elevated at front
  b(1.2,1.0,1.2,M.slBd, 0,1.0,1.4);
  // Snout
  b(0.8,0.5,0.5,M.slBl, 0,0.8,2.1);
  // Nose
  b(0.2,0.15,0.1,M.slEy, 0,0.95,2.35);
  // Eyes â€” white + black pupil
  b(0.2,0.2,0.1,M.slEW,-0.4,1.2,2.0);  // eye white L
  b(0.2,0.2,0.1,M.slEW, 0.4,1.2,2.0);  // eye white R
  b(0.1,0.1,0.12,M.slEy,-0.38,1.2,2.02); // pupil L (slightly inward)
  b(0.1,0.1,0.12,M.slEy, 0.38,1.2,2.02); // pupil R
  // Front flippers
  const fl=new THREE.Mesh(new THREE.BoxGeometry(1.2*S,0.2*S,0.8*S),M.slBd);
  fl.rotation.z=-Math.PI/8;fl.position.set(-1.2*S,0.1*S,1.0*S);fl.castShadow=true;g.add(fl);
  const fr=new THREE.Mesh(new THREE.BoxGeometry(1.2*S,0.2*S,0.8*S),M.slBd);
  fr.rotation.z= Math.PI/8;fr.position.set( 1.2*S,0.1*S,1.0*S);fr.castShadow=true;g.add(fr);
  // Tail flippers
  const tl=new THREE.Mesh(new THREE.BoxGeometry(0.6*S,0.2*S,1.0*S),M.slBd);
  tl.rotation.y=-Math.PI/6;tl.position.set(-0.35*S,0.1*S,-1.5*S);tl.castShadow=true;g.add(tl);
  const tr2=new THREE.Mesh(new THREE.BoxGeometry(0.6*S,0.2*S,1.0*S),M.slBd);
  tr2.rotation.y= Math.PI/6;tr2.position.set( 0.35*S,0.1*S,-1.5*S);tr2.castShadow=true;g.add(tr2);
}

function makePolarBear3D(g,S){
  // Polar bear â€” white, standing upright, right arm waving
  function b(w,h,d,mat,px,py,pz){const m=new THREE.Mesh(new THREE.BoxGeometry(w*S,h*S,d*S),mat);m.position.set(px*S,py*S,pz*S);m.castShadow=true;g.add(m);return m;}
  // Body
  b(1.6,2.2,1.2,M.pbWh, 0,1.6,0);
  // Head
  b(1.2,1.2,1.2,M.pbWh, 0,3.1,0.2);
  // Snout
  b(0.6,0.4,0.4,M.pbWh, 0,2.9,0.9);
  // Nose
  b(0.2,0.1,0.1,M.pbBk, 0,3.05,1.1);
  // Eyes
  b(0.15,0.15,0.1,M.pbBk,-0.3,3.3,0.8);
  b(0.15,0.15,0.1,M.pbBk, 0.3,3.3,0.8);
  // Ears
  b(0.25,0.25,0.2,M.pbWh,-0.5,3.7,0);
  b(0.25,0.25,0.2,M.pbWh, 0.5,3.7,0);
  // Left arm (resting down)
  b(0.5,1.5,0.5,M.pbWh,-1.05,1.8,0);
  // Right arm (waving â€” rotated 45Â°)
  const armR=new THREE.Mesh(new THREE.BoxGeometry(0.5*S,1.5*S,0.5*S),M.pbWh);
  armR.position.set(1.1*S,2.4*S,0);armR.rotation.z=Math.PI/4;armR.castShadow=true;g.add(armR);
  // Legs
  b(0.6,0.8,0.6,M.pbWh,-0.4,0.4,0.1);
  b(0.6,0.8,0.6,M.pbWh, 0.4,0.4,0.1);
}

// No 3D label sprites â€” tooltip is HTML-only, positioned via world projection

// â”€â”€ Spawn Laila + Waddler â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function spawnAll(){
  if(lailaGroup)scene.remove(lailaGroup);
  if(waddlerGroup)scene.remove(waddlerGroup);

  // Laila â€” player (bow accessory identifies her)
  const lRefs={};
  lailaGroup=buildPenguinGroup(PS,'bow',lRefs);
  lWL=lRefs.wL;lWR=lRefs.wR;lFL=lRefs.fL;lFR=lRefs.fR;lHead=lRefs.head;lBodyMesh=lRefs.body;
  lPos.set(0,0,0);
  lailaGroup.position.set(0,terrainH(0,0)-0.12*PS,0);
  lYaw=0;camYaw=0;lAnimT=0;lStep=0;
  lState='idle';stateT=0;idleT=0;waddleT=0;waddleNext=5000+Math.random()*6000;
  scene.add(lailaGroup);

  // Waddler â€” wanders
  waddlerGroup=buildPenguinGroup(PS,null,null);
  // wire up waddler refs from children order: body(0),belly(1),head(2),eyeL(3),eyeR(4),pupL(5),pupR(6),beak(7),wL(8),wR(9),fL(10),fR(11)
  const wch=waddlerGroup.children;
  wWL=wch[8];wWR=wch[9];wFL=wch[10];wFR=wch[11];

  const _st=loadSettings();
  const _diff=Math.max(1,Math.min(5,_st.difficulty||3));  // 1=easy,3=medium,5=hard
  const _wrad=Math.max(400,Math.min(1400,_st.worldSize||WRAD));
  const maxD=_wrad*.82;
  // difficulty controls how far Waddler spawns: easy=40%, hard=90% of world radius
  const _frac=0.40+(_diff-1)*0.125;                   // 1â†’40%, 3â†’65%, 5â†’90%
  const minD=Math.min(_wrad*_frac+round*20,maxD*.95);
  const ang=Math.random()*Math.PI*2,d=Math.min(minD+Math.random()*(_wrad*.1),maxD);
  wPos.set(Math.cos(ang)*d,0,Math.sin(ang)*d);
  wYaw=0;wVX=0;wVZ=0;wTimer=0;wAnimT=0;wStep=0;
  waddlerGroup.position.set(wPos.x,terrainH(wPos.x,wPos.z)-0.12*PS,wPos.z);
  scene.add(waddlerGroup);
}

// â”€â”€ POI click (3D canvas) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('gc').addEventListener('click',e=>{
  if(!gameRunning||!POIS.length)return;
  const rect=document.getElementById('gc').getBoundingClientRect();
  const ndc=new THREE.Vector2(((e.clientX-rect.left)/rect.width)*2-1,-((e.clientY-rect.top)/rect.height)*2+1);
  const ray=new THREE.Raycaster();ray.setFromCamera(ndc,camera);
  const targets=[];
  POIS.forEach(p=>{if(p.group)p.group.children.forEach(c=>{if(c.isMesh)targets.push(c);});});
  const hits=ray.intersectObjects(targets,false);
  if(hits.length){
    const obj=hits[0].object;
    const poi=POIS.find(p=>p.group&&p.group.children.includes(obj));
    if(poi){showTooltip(poi);return;}
  }
  hideTooltip();
});

// â”€â”€ Tooltip â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const TYPE_LABELS={person:'Person',shop:'Shop',store:'Store',stall:'Stall',land:'Landmark',seal:'Seal',polarbear:'Polar Bear',custom:'Place'};
const EL_tag=document.getElementById('poi-tag');
const EL_ptType=document.getElementById('pt-type');
const EL_ptName=document.getElementById('pt-name');
const EL_ptUrl=document.getElementById('pt-url');
const _tooltipWP=new THREE.Vector3(); // reusable â€” avoids allocating per frame
function showTooltip(poi){
  activePoi=poi;
  EL_ptType.textContent=TYPE_LABELS[poi.type]||'Place';
  EL_ptName.textContent=poi.name;
  if(poi.url){EL_ptUrl.textContent=poi.url.replace(/^https?:\/\//,'');EL_ptUrl.href=poi.url;EL_ptUrl.style.display='block';}
  else EL_ptUrl.style.display='none';
  repositionTooltip(poi);
  EL_tag.style.display='block';
}
function repositionTooltip(poi){
  if(!poi.group)return;
  const typeH={person:5.0,shop:6.5,store:8.0,stall:6.0,land:7.0,seal:2.8,polarbear:5.5};
  const gy=terrainH(poi.x,poi.z);
  _tooltipWP.set(poi.x,gy+(typeH[poi.type]||6.0)*CS,poi.z);
  _tooltipWP.project(camera);
  const sx=(_tooltipWP.x+1)/2*window.innerWidth;
  const sy=(-_tooltipWP.y+1)/2*window.innerHeight;
  const tw=200,th=90;
  EL_tag.style.left=Math.max(8,Math.min(window.innerWidth-tw-8,sx-tw/2))+'px';
  EL_tag.style.top=Math.max(8,Math.min(window.innerHeight-th-8,sy-th-10))+'px';
}
function hideTooltip(){EL_tag.style.display='none';activePoi=null;}
function openPoiLink(e){
  e.preventDefault();
  if(activePoi&&activePoi.url){
    trackClick(activePoi.id);
    window.open(activePoi.url,'_blank','noopener');
  }
  return false;
}

// â”€â”€ Waddler speech bubble â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const EL_waddlerMsg=document.getElementById('waddler-msg');
const _waddlerWP=new THREE.Vector3();
let waddlerMsgTimer=null;
function showWaddlerMsg(){
  const gy=terrainH(wPos.x,wPos.z);
  _waddlerWP.set(wPos.x,gy+6.5*PS,wPos.z);
  _waddlerWP.project(camera);
  if(_waddlerWP.z>1){EL_waddlerMsg.style.display='none';return;} // behind camera
  const sx=(_waddlerWP.x+1)/2*window.innerWidth;
  const sy=(-_waddlerWP.y+1)/2*window.innerHeight;
  EL_waddlerMsg.style.left=Math.max(8,Math.min(window.innerWidth-240,sx-120))+'px';
  EL_waddlerMsg.style.top=Math.max(8,sy-90)+'px';
  // On first show, reset text and start 1.5s timer to change to "Selfie time!"
  if(EL_waddlerMsg.style.display==='none'||EL_waddlerMsg.style.display===''){
    document.getElementById('wb-text').textContent='Hey Laila!! You found me!! \uD83D\uDC99';
    if(waddlerMsgTimer)clearTimeout(waddlerMsgTimer);
    waddlerMsgTimer=setTimeout(()=>{
      document.getElementById('wb-text').textContent='Selfie time! \uD83D\uDCF8';
    },1500);
  }
  EL_waddlerMsg.style.display='block';
}
function hideWaddlerMsg(){
  EL_waddlerMsg.style.display='none';
  if(waddlerMsgTimer){clearTimeout(waddlerMsgTimer);waddlerMsgTimer=null;}
  document.getElementById('wb-text').textContent='Hey Laila!! You found me!! \uD83D\uDC99';
}

// â”€â”€ Reunion sequence â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let reunionPhase=null,reunionT=0,_reunionQueued=false,_reunionTimer=null;
const EL_reunionHearts=document.getElementById('reunion-hearts');

function startReunion(){
  if(reunionPhase)return;
  _reunionQueued=false;_reunionTimer=null;
  reunionPhase='approach';reunionT=0;
  hideWaddlerMsg();
  // stop Waddler wandering
  wVX=0;wVZ=0;
  sFound();
  if(window.CrazyGames){try{window.CrazyGames.SDK.game.gameplayStop();}catch(e){}}
  // Show hearts immediately, then selfie screen after 1.2s (wings spread in that time)
  spawnHearts();
  setTimeout(()=>{
    EL_reunionHearts.style.display='none';
    EL_reunionHearts.innerHTML='';
    reunionPhase=null;
    // Suspend audio â€” kills all remaining oscillator output (sPing, sFound notes)
    if(ACX&&ACX.state==='running')ACX.suspend();
    renderPortrait(); // capture 3D scene before showing screen
    document.getElementById('found-msg').textContent=`Laila & Waddler \u2014 Round ${round} complete! \uD83D\uDC99`;
    document.getElementById('found-screen').style.display='flex';
  },1200);
}

function spawnHearts(){
  EL_reunionHearts.style.display='block';
  EL_reunionHearts.innerHTML='';
  // Project world midpoint between Laila and Waddler onto screen
  const mx=(lPos.x+wPos.x)/2, mz=(lPos.z+wPos.z)/2;
  const mGy=terrainH(mx,mz)+3*PS;
  _tooltipWP.set(mx,mGy,mz);
  _tooltipWP.project(camera);
  const sx=(_tooltipWP.x+1)/2*window.innerWidth;
  const sy=(-_tooltipWP.y+1)/2*window.innerHeight;
  ['ğŸ’™','ğŸ’—'].forEach((emoji,i)=>{
    const h=document.createElement('div');
    h.className='heart-bubble';
    h.textContent=emoji;
    h.style.left=(sx-18+i*36)+'px';
    h.style.top=(sy-20)+'px';
    h.style.fontSize='38px';
    h.style.animationDelay=(i*.35)+'s';
    h.style.animationDuration='2.5s';
    EL_reunionHearts.appendChild(h);
  });
}

function applyReunion(dt){
  if(!reunionPhase)return;
  reunionT+=dt;
  const t=reunionT*.001;
  // Both face toward camera â€” looks great and avoids angle-fighting
  const camAngle=Math.atan2(camera.position.x-lPos.x, camera.position.z-lPos.z);
  lailaGroup.rotation.y=-camAngle;
  waddlerGroup.rotation.y=-(camAngle+0.25); // Waddler slightly angled
  // Lock positions on terrain (no nudging â€” they're already close)
  lailaGroup.position.set(lPos.x,terrainH(lPos.x,lPos.z)-0.12*PS,lPos.z);
  waddlerGroup.position.set(wPos.x,terrainH(wPos.x,wPos.z)-0.12*PS,wPos.z);
  // Hug wings â€” ramp 0â†’1 over 0.4s starting at t=0.2s
  const hug=Math.min(1,Math.max(0,(t-.2)*2.5));
  // Wings spread OUTWARD (T-pose) â€” left wing down-left, right wing down-right
  if(lWL)lWL.rotation.z=-hug*1.2;
  if(lWR)lWR.rotation.z= hug*1.2;
  if(wWL)wWL.rotation.z=-hug*1.2;
  if(wWR)wWR.rotation.z= hug*1.2;
}

function renderPortrait(){
  const pc=document.getElementById('portrait-canvas');
  if(!pc||!renderer||!scene)return;
  // Temporarily snap Waddler beside Laila for the selfie photo
  const sideOffset=2.5*PS;
  const snapWx=lPos.x+sideOffset, snapWz=lPos.z;
  const savedWx=waddlerGroup.position.x, savedWz=waddlerGroup.position.z;
  waddlerGroup.position.set(snapWx,terrainH(snapWx,snapWz)-0.12*PS,snapWz);
  // Portrait camera â€” in FRONT of the penguins (positive Z direction from them)
  const mx=(lPos.x+snapWx)/2, mz=lPos.z;
  const mGy=terrainH(mx,mz);
  const portCam=new THREE.PerspectiveCamera(40,1,0.5,1400);
  portCam.position.set(mx,mGy+3.5,mz+6);
  portCam.lookAt(mx,mGy+1.8,mz);
  // Rotate BOTH penguins to face the portrait camera before rendering
  const pfAngle=Math.atan2(portCam.position.x-mx, portCam.position.z-mz);
  const savedLRot=lailaGroup.rotation.y, savedWRot=waddlerGroup.rotation.y;
  lailaGroup.rotation.y=-pfAngle;
  waddlerGroup.rotation.y=-pfAngle; // both face exactly the same direction for photo
  // Ensure wings are fully spread for the portrait
  if(lWL)lWL.rotation.z=-1.2; if(lWR)lWR.rotation.z=1.2;
  if(wWL)wWL.rotation.z=-1.2; if(wWR)wWR.rotation.z=1.2;
  // Render at 512Ã—512 â€” force pixelRatio=1 so drawImage copies exactly 512Ã—512 pixels
  const savedPR=renderer.getPixelRatio();
  renderer.setPixelRatio(1);
  renderer.setSize(512,512,false);
  renderer.render(scene,portCam);
  // Copy pixels to portrait canvas BEFORE restoring renderer size
  pc.width=512;pc.height=512;
  const ctx=pc.getContext('2d');
  ctx.drawImage(renderer.domElement,0,0,512,512);
  // â”€â”€ Restore renderer immediately after pixel copy â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  renderer.setPixelRatio(savedPR);
  renderer.setSize(window.innerWidth,window.innerHeight,false);
  // Restore rotations
  lailaGroup.rotation.y=savedLRot; waddlerGroup.rotation.y=savedWRot;
  // Restore Waddler to its actual position
  waddlerGroup.position.set(savedWx,terrainH(savedWx,savedWz)-0.12*PS,savedWz);
  // â”€â”€ Text overlay â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ctx.fillStyle='rgba(0,0,0,0.40)';
  ctx.fillRect(0,358,512,154);
  ctx.textAlign='center';
  ctx.fillStyle='#ff77cc';
  ctx.font='bold 30px Courier New';
  ctx.fillText('Laila & Waddler',256,403);
  ctx.fillStyle='#ffffff';
  ctx.font='bold 24px Courier New';
  ctx.fillText('Happily Ever After \u2728',256,445);
  ctx.font='36px serif';
  ctx.fillText('\uD83D\uDC99',185,115);  // ğŸ’™
  ctx.fillText('\uD83D\uDC97',315,88);   // ğŸ’—
}

function sharePortrait(){
  const pc=document.getElementById('portrait-canvas');
  if(!pc)return;
  pc.toBlob(blob=>{
    if(!blob)return;
    const file=new File([blob],'laila-and-waddler.png',{type:'image/png'});
    if(navigator.canShare&&navigator.canShare({files:[file]})){
      navigator.share({
        title:'Laila found Waddler! ğŸ’™',
        text:'I found Waddler in Finding Penguin! â„ï¸ğŸ§\nfindingpenguin.com',
        url:'https://findingpenguin.com',
        files:[file],
      }).catch(()=>{}); // user cancelled â€” ignore
    } else {
      // Desktop fallback: download the PNG
      const a=document.createElement('a');
      a.href=URL.createObjectURL(blob);
      a.download='laila-and-waddler.png';
      a.click();
      URL.revokeObjectURL(a.href);
    }
  },'image/png');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ADMIN + MAP SYSTEM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function promptAdmin(){
  document.getElementById('admin-login').style.display='flex';
  document.getElementById('al-pw').value='';
  document.getElementById('al-err').textContent='';
}
function tryLogin(){
  if(document.getElementById('al-pw').value===ADMIN_PW){
    adminOK=true;
    document.getElementById('admin-login').style.display='none';
    document.getElementById('type-picker').style.display='flex';
    document.getElementById('admin-btn').textContent='âœ… ADMIN';
    document.getElementById('map-hint').textContent='Select a type above, then click the map to place';
  }else{
    document.getElementById('al-err').textContent='Wrong password.';
    document.getElementById('al-pw').value='';
  }
}

// Type picker
function pickType(t,el){
  mapTool=t;
  document.querySelectorAll('.type-card').forEach(c=>c.classList.remove('active'));
  if(el)el.classList.add('active');
  cancelPlace(); // clear any pending form
  if(t==='none'){
    document.getElementById('map-hint').textContent='Click any placed item on the map to view details';
  } else {
    const labels={person:'Person',shop:'Shop',store:'Store',stall:'Stall',land:'Landmark'};
    document.getElementById('map-hint').textContent=`Click on the map to place a ${labels[t]||t}`;
  }
}

// Map open/close
let mapDT=null;
document.getElementById('hud-logo').addEventListener('click',()=>{
  if(mapDT){clearTimeout(mapDT);mapDT=null;openMap();}
  else mapDT=setTimeout(()=>mapDT=null,340);
});
function openMap(){if(!gameRunning)return;document.getElementById('map-ov').style.display='flex';drawMap();}
function closeMap(){document.getElementById('map-ov').style.display='none';cancelPlace();}

// Map click â€” single click to place
document.getElementById('map-cv').addEventListener('click',e=>{
  if(!adminOK||mapTool==='none')return;
  const mc=document.getElementById('map-cv');
  const rect=mc.getBoundingClientRect();
  const rx=(e.clientX-rect.left)*(mc.width/rect.width);
  const ry=(e.clientY-rect.top)*(mc.height/rect.height);
  const half=mc.width/2,scale=mc.width/(WRAD*2.1);
  const wx=(rx-half)/scale,wz=(ry-half)/scale;
  pendPoi={type:mapTool,name:'',url:'',x:wx,z:wz,id:'poi_'+Date.now()};
  // Show inline form
  const pf=document.getElementById('place-form');
  document.getElementById('pf-title').textContent='PLACE '+mapTool.toUpperCase()+' HERE';
  document.getElementById('pf-name').value='';
  document.getElementById('pf-url').value='';
  pf.style.display='flex';
  setTimeout(()=>document.getElementById('pf-name').focus(),50);
  drawMap(); // show pending dot
});

function confirmPlace(){
  if(!pendPoi)return;
  const name=document.getElementById('pf-name').value.trim();
  if(!name){document.getElementById('pf-name').focus();document.getElementById('pf-name').style.borderColor='#ff6688';return;}
  document.getElementById('pf-name').style.borderColor='';
  pendPoi.name=name;
  pendPoi.url=document.getElementById('pf-url').value.trim();
  // Give person variant based on index
  if(pendPoi.type==='person')pendPoi._variantIdx=POIS.filter(p=>p.type==='person').length;
  POIS.push(pendPoi);
  if(gameRunning)makePOIMesh(pendPoi);
  savePOIs();
  pendPoi=null;
  document.getElementById('place-form').style.display='none';
  drawMap();
}
function cancelPlace(){
  pendPoi=null;
  document.getElementById('place-form').style.display='none';
}

// â”€â”€ Persistence â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function savePOIs(){try{localStorage.setItem('fp_pois',JSON.stringify(POIS));}catch(e){}}
function loadPOIs(){
  try{const d=localStorage.getItem('fp_pois');if(d){
    POIS=JSON.parse(d);
    // Normalise missing visible field â†’ true
    POIS.forEach(p=>{if(p.visible===undefined)p.visible=true;});
    return;
  }}catch(e){}
  fetch('pois.json').then(r=>r.json()).then(data=>{if(data&&data.pois)POIS=data.pois;}).catch(()=>{});
}

// â”€â”€ Settings (terrain density, worker URL) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loadSettings(){
  try{const d=localStorage.getItem('fp_settings');if(d)return JSON.parse(d);}catch(e){}
  return {terrainDensity:4,worldSize:700,difficulty:4,workerUrl:'https://finding-penguin-worker.domain-sparrow.workers.dev'};
}

// â”€â”€ Analytics click tracking â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function trackClick(poiId){
  try{
    const url=(loadSettings().workerUrl||'').trim();
    if(!url)return;
    fetch(url+'/click?id='+encodeURIComponent(poiId),{method:'POST'}).catch(()=>{});
  }catch(e){}
}

// â”€â”€ Map draw â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawMap(){
  const mc=document.getElementById('map-cv'),mX=mc.getContext('2d');
  const S=mc.width,half=S/2,scale=S/(WRAD*2.1);
  mX.clearRect(0,0,S,S);
  const bg=mX.createRadialGradient(half,half,0,half,half,half);
  bg.addColorStop(0,'#eef6ff');bg.addColorStop(1,'#bcd8f0');
  mX.fillStyle=bg;mX.fillRect(0,0,S,S);
  mX.strokeStyle='rgba(100,160,220,.1)';mX.lineWidth=1;
  for(let i=0;i<=S;i+=S/10){mX.beginPath();mX.moveTo(i,0);mX.lineTo(i,S);mX.stroke();mX.beginPath();mX.moveTo(0,i);mX.lineTo(S,i);mX.stroke();}
  mX.strokeStyle='rgba(100,160,220,.2)';mX.lineWidth=2;mX.beginPath();mX.arc(half,half,WRAD*scale,0,Math.PI*2);mX.stroke();

  // type colours on map
  const TC={person:'#5588ff',shop:'#ff8844',store:'#44aa66',stall:'#cc44aa',land:'#8888cc',seal:'#44aacc',sealion:'#2299bb',custom:'#aaaaaa'};
  POIS.forEach(p=>{
    const px=half+p.x*scale,pz=half+p.z*scale;
    mX.fillStyle=TC[p.type]||'#888';
    mX.beginPath();mX.arc(px,pz,5,0,Math.PI*2);mX.fill();
    mX.strokeStyle='rgba(255,255,255,.7)';mX.lineWidth=1.5;mX.stroke();
    mX.fillStyle='rgba(20,50,110,.7)';mX.font='7px Courier New';mX.textAlign='center';mX.textBaseline='top';
    mX.fillText(p.name.substring(0,10),px,pz+7);
  });

  // Pending placement dot
  if(pendPoi){
    const px=half+pendPoi.x*scale,pz=half+pendPoi.z*scale;
    mX.fillStyle='rgba(255,220,0,.85)';mX.beginPath();mX.arc(px,pz,7,0,Math.PI*2);mX.fill();
    mX.strokeStyle='#fff';mX.lineWidth=2;mX.stroke();
  }

  // Waddler
  const wx=half+wPos.x*scale,wz=half+wPos.z*scale;
  mX.fillStyle='#4488ff';mX.beginPath();mX.arc(wx,wz,5,0,Math.PI*2);mX.fill();
  mX.fillStyle='rgba(20,50,110,.55)';mX.font='7px Courier New';mX.textAlign='center';mX.textBaseline='top';mX.fillText('Waddler',wx,wz+7);

  // Laila
  const lx=half+lPos.x*scale,lz=half+lPos.z*scale;
  mX.fillStyle='#1a3a8a';mX.beginPath();mX.arc(lx,lz,5,0,Math.PI*2);mX.fill();
  mX.strokeStyle='#1a3a8a';mX.lineWidth=2;mX.beginPath();mX.moveTo(lx,lz);mX.lineTo(lx+Math.sin(lYaw)*13,lz+Math.cos(lYaw)*13);mX.stroke();
  mX.fillStyle='rgba(20,50,110,.7)';mX.font='7px Courier New';mX.textAlign='center';mX.textBaseline='top';mX.fillText('Laila',lx,lz+7);

  mX.fillStyle='#1a3a6a';mX.font='9px Courier New';mX.textAlign='left';mX.textBaseline='bottom';
  mX.fillText('Dist: ~'+Math.round(lPos.distanceTo(wPos))+' | Rnd '+round,6,S-5);
}

// â”€â”€ State machine â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setState(s){if(lState===s)return;prevState=lState;lState=s;stateT=0;if(s==='circle')circleYaw=lYaw;}

// â”€â”€ Laila animation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function applyAnim(dt){
  if(!lWL)return;stateT+=dt;const t=stateT*.001;
  lWL.rotation.z=0;lWR.rotation.z=0;lFL.rotation.x=0;lFR.rotation.x=0;
  if(lHead){lHead.rotation.x=0;lHead.rotation.z=0;}
  if(lBodyMesh)lBodyMesh.rotation.z=0;
  lailaGroup.rotation.x=0;
  if(lState==='walk'){
    const sw=Math.sin(lStep*Math.PI/4)*.38;
    lWL.rotation.z=sw;lWR.rotation.z=-sw;lFL.rotation.x=-sw*.55;lFR.rotation.x=sw*.55;
  }else if(lState==='sit'){
    lFL.rotation.x=-.75;lFR.rotation.x=-.75;lWL.rotation.z=.38;lWR.rotation.z=-.38;
    if(lHead)lHead.rotation.x=.18;
  }else if(lState==='sleep'){
    lailaGroup.rotation.x=-.35;lFL.rotation.x=-1.1;lFR.rotation.x=-1.1;
    lWL.rotation.z=.55;lWR.rotation.z=-.55;if(lHead)lHead.rotation.x=.45;
    // position.y already set by game loop; just add the breathing bob
    lailaGroup.position.y+=Math.sin(t*1.9)*.04;
  }else if(lState==='rising'){
    const prog=Math.min(1,t/.65);
    lFL.rotation.x=-.75*(1-prog);lFR.rotation.x=-.75*(1-prog);
    lWL.rotation.z=.38*(1-prog);lWR.rotation.z=-.38*(1-prog);
    if(prevState==='sleep')lailaGroup.rotation.x=-.35*(1-prog);
    if(prog>=1)setState('idle');
  }else if(lState==='jump'){
    const prog=Math.min(1,t/.55),arc=Math.sin(prog*Math.PI)*3.5*PS;
    lailaGroup.position.y=terrainH(lPos.x,lPos.z)+arc;
    lWL.rotation.z=arc*.35;lWR.rotation.z=-arc*.35;
    if(prog>=1)setState('idle');
  }else if(lState==='circle'){
    lYaw=circleYaw+t*3.0;lWL.rotation.z=Math.sin(t*5)*.3;lWR.rotation.z=-Math.sin(t*5)*.3;
    if(t>=2.0)setState('idle');
  }else if(lState==='wave'){
    lWR.rotation.z=-(Math.sin(t*7)*.85+.3);if(lHead)lHead.rotation.x=.12;if(t>=1.4)setState('idle');
  }else if(lState==='bow'){
    const bow=Math.sin(Math.min(t,1.5)/1.5*Math.PI)*.68;
    lailaGroup.rotation.x=bow;if(lHead)lHead.rotation.x=-bow*.5;if(t>=2.0)setState('idle');
  }else if(lState==='waddle'){
    const sw=Math.sin(t*3.2)*.22;
    if(lBodyMesh)lBodyMesh.rotation.z=sw;
    lWL.rotation.z=sw+.1;lWR.rotation.z=-sw-.1;lFL.rotation.x=sw*.25;lFR.rotation.x=-sw*.25;
    if(t>=1.8)setState('idle');
  }else{
    const br=Math.sin(t*1.7)*.03;lWL.rotation.z=br;lWR.rotation.z=-br;
  }
}

// â”€â”€ Waddler animation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function animW(step){
  if(!wWL)return;
  const sw=Math.sin(step*Math.PI/4)*.38;
  wWL.rotation.z=sw;wWR.rotation.z=-sw;wFL.rotation.x=-sw*.55;wFR.rotation.x=sw*.55;
}

// â”€â”€ Snowfall â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Cached references â€” set once in buildWorld
let _sfPoints=null,_sfArr=null;
function tickSnow(dt){
  if(!_sfPoints)return;
  const arr=_sfArr,fall=dt*.002,drift=Math.sin(Date.now()*.0003)*.004;
  for(let i=0,n=arr.length;i<n;i+=3){
    arr[i]+=drift;       // x drift
    arr[i+1]-=fall;      // y fall
    if(arr[i+1]<-1)arr[i+1]=60;
  }
  _sfPoints.geometry.attributes.position.needsUpdate=true;
}

// â”€â”€ Camera â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateCam(){
  const diff=((lYaw-camYaw)+Math.PI*3)%(Math.PI*2)-Math.PI;camYaw+=diff*.08;
  const gy=terrainH(lPos.x,lPos.z);
  camera.position.set(lPos.x+Math.sin(camYaw)*CAM_D,gy+CAM_H,lPos.z+Math.cos(camYaw)*CAM_D);
  camera.lookAt(lPos.x,gy+2*PS,lPos.z);
}

// â”€â”€ HUD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const EL_warmth=document.getElementById('warmth');
const EL_compass=document.getElementById('compass-box');
const EL_hint=document.getElementById('action-hint');
const _resting_states=['idle','sit','sleep'];
const ARR=['â¬†ï¸','â†—ï¸','â¡ï¸','â†˜ï¸','â¬‡ï¸','â†™ï¸','â¬…ï¸','â†–ï¸'];
let _lastWarmth='',_lastCompass='';
function updateHUD(){
  const dx=wPos.x-lPos.x,dz=wPos.z-lPos.z,d=Math.hypot(dx,dz);
  let txt='ğŸŒ¨ï¸ Very far...';
  if(d<10)txt='ğŸ”¥ğŸ”¥ ALMOST THERE!!';
  else if(d<28)txt='ğŸ”¥ Very close!!';
  else if(d<70)txt='ğŸŸ¡ Getting warmer!';
  else if(d<150)txt='ğŸ”µ Somewhere nearby...';
  else if(d<300)txt='â„ï¸ Far away...';
  if(txt!==_lastWarmth){EL_warmth.textContent=txt;_lastWarmth=txt;}
  const wa=Math.atan2(dx,dz),rel=((wa-lYaw)%(Math.PI*2)+Math.PI*2)%(Math.PI*2);
  const ctxt=d<12?'ğŸ’™':ARR[Math.round(rel/(Math.PI/4))%8];
  if(ctxt!==_lastCompass){EL_compass.textContent=ctxt;_lastCompass=ctxt;}
  sPing(Math.max(0,1-d/600));
  // Waddler speech bubble when nearby â€” show first, then trigger reunion after 1.8s
  if(d<12&&!reunionPhase){
    showWaddlerMsg();
    if(!_reunionQueued){_reunionQueued=true;_reunionTimer=setTimeout(()=>{startReunion();},1800);}
  } else if(d>=12&&!reunionPhase){hideWaddlerMsg();_reunionQueued=false;}

  // POI proximity
  let cl=null,cd=30;
  POIS.forEach(p=>{const pd=Math.hypot(p.x-lPos.x,p.z-lPos.z);if(pd<cd){cd=pd;cl=p;}});
  if(cl!==nearPoi){
    nearPoi=cl;
    if(cl){ showTooltip(cl); }
    else { hideTooltip(); activePoi=null; }
  }
  if(activePoi&&activePoi.group)repositionTooltip(activePoi);
}

// â”€â”€ Main loop â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SPEED=.11;let lastMS=0;
function gameLoop(ts){
  requestAnimationFrame(gameLoop);
  const dt=Math.min(ts-lastMS,80);lastMS=ts;
  idleT+=dt;waddleT+=dt;
  if(!gameRunning){if(renderer)renderer.render(scene,camera);return;}

  const tl=K['ArrowLeft']||K['a']||K['A'];
  const tr=K['ArrowRight']||K['d']||K['D'];
  const tf=K['ArrowUp']||K['w']||K['W'];
  const tb=K['ArrowDown']||K['s']||K['S'];
  const anyMove=(!reunionPhase)&&(tl||tr||tf||tb||Math.abs(TD.x)>.01||Math.abs(TD.z)>.01);
  if(!reunionPhase){if(tl)lYaw-=.024;if(tr)lYaw+=.024;lYaw+=TD.z*.016;}

  const inAction=['jump','circle','wave','bow'].includes(lState);
  if(!inAction){
    if(anyMove){
      if(['sit','sleep','waddle'].includes(lState))setState('rising');
      else if(lState!=='rising'&&lState!=='walk')setState('walk');
      idleT=0;waddleT=0;
    }else{
      if(lState==='walk')setState('idle');
      if(lState==='idle'&&idleT>9000){setState('sit');idleT=0;}
      if(lState==='sit'&&stateT>7000)setState('sleep');
      if(lState==='idle'&&waddleT>waddleNext){setState('waddle');waddleT=0;waddleNext=5000+Math.random()*7000;sWaddle();}
    }
  }

  const canMove=(lState==='walk'||lState==='rising'||lState==='idle')&&!inAction&&!['sit','sleep'].includes(lState);
  let mx=0,mz=0;
  if(canMove){
    const fX=-Math.sin(lYaw),fZ=-Math.cos(lYaw);
    if(tf){mx+=fX;mz+=fZ;}if(tb){mx-=fX;mz-=fZ;}
    if(Math.abs(TD.x)>.01){mx+=fX*TD.x;mz+=fZ*TD.x;}
  }
  if(Math.abs(mx)>.0005||Math.abs(mz)>.0005){
    const usingTouch=Math.abs(TD.x)>.01||Math.abs(TD.z)>.01;
    const spd=SPEED*dt*.5*(usingTouch?.48:1),LIM=WRAD*.9;
    const len=Math.hypot(mx,mz)||1;
    lPos.x=Math.max(-LIM,Math.min(LIM,lPos.x+(mx/len)*spd));
    lPos.z=Math.max(-LIM,Math.min(LIM,lPos.z+(mz/len)*spd));
    lAnimT+=dt;if(lAnimT>230){lStep=(lStep+1)%8;lAnimT=0;sStep();}
  }

  const gy=terrainH(lPos.x,lPos.z);
  if(lState!=='sleep'&&lState!=='jump'){
    lailaGroup.position.set(lPos.x,gy-0.12*PS,lPos.z);
  }else{
    lailaGroup.position.x=lPos.x;lailaGroup.position.z=lPos.z;
    if(lState==='sleep')lailaGroup.position.y=gy-0.9*PS;
  }
  if(!reunionPhase)lailaGroup.rotation.y=-lYaw;
  applyAnim(dt);applyReunion(dt);

  // Waddler AI â€” frozen during reunion
  if(!reunionPhase){
    wTimer-=dt;
    if(wTimer<=0){wTimer=2000+Math.random()*3500;const a=Math.random()*Math.PI*2;wVX=Math.cos(a)*.04;wVZ=Math.sin(a)*.04;wYaw=a;}
    const WL=WRAD*.88;
    wPos.x=Math.max(-WL,Math.min(WL,wPos.x+wVX));wPos.z=Math.max(-WL,Math.min(WL,wPos.z+wVZ));
    waddlerGroup.position.set(wPos.x,terrainH(wPos.x,wPos.z)-0.12*PS,wPos.z);
    waddlerGroup.rotation.y=wYaw;
    wAnimT+=dt;if(wAnimT>240){wStep=(wStep+1)%8;wAnimT=0;}animW(wStep);
  }

  // Snowfall follows player
  if(_sfPoints){_sfPoints.position.x=lPos.x;_sfPoints.position.z=lPos.z;}

  tickSnow(dt);updateCam();updateHUD();
  EL_hint.style.opacity=(_resting_states.includes(lState))?'0.75':'0';
  renderer.render(scene,camera);
}

// â”€â”€ Found / Next â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function foundPenguin(){
  gameRunning=false;sFound();
  document.getElementById('found-msg').textContent=`Laila found Waddler! ğŸ’™  Round ${round} complete.`;
  document.getElementById('found-screen').style.display='flex';
}
function nextRound(){
  round++;
  reunionPhase=null;reunionT=0;_reunionQueued=false;
  if(_reunionTimer){clearTimeout(_reunionTimer);_reunionTimer=null;}
  // Reset wing poses for next round
  if(lWL)lWL.rotation.z=0;if(lWR)lWR.rotation.z=0;
  if(wWL)wWL.rotation.z=0;if(wWR)wWR.rotation.z=0;
  EL_reunionHearts.style.display='none';EL_reunionHearts.innerHTML='';
  hideWaddlerMsg();
  document.getElementById('found-screen').style.display='none';
  // Resume audio for next round
  if(ACX&&ACX.state==='suspended')ACX.resume();
  spawnAll();gameRunning=true;
  if(window.CrazyGames){try{window.CrazyGames.SDK.game.gameplayStart();}catch(e){}}
}
async function startGame(){
  initAudio();
  // Hide intro immediately â€” instant feedback, no waiting for SDK
  introAlive=false;
  document.getElementById('intro-screen').style.display='none';
  loadPOIs();initThree();buildWorld();spawnAll();gameRunning=true;
  requestAnimationFrame(gameLoop);
  // Init SDK in background after game is already running
  if(window.CrazyGames){try{await window.CrazyGames.SDK.init();window.CrazyGames.SDK.game.gameplayStart();}catch(e){}}
}

// â”€â”€ Input â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('keydown',e=>{
  if(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight',' '].includes(e.key))e.preventDefault();
  K[e.key]=true;if(!gameRunning)return;
  const inAction=['jump','circle','wave','bow'].includes(lState);
  const resting=!['walk','rising'].includes(lState)&&!inAction;
  if(resting){
    if(e.key==='j'||e.key==='J'){setState('jump');sJump();}
    if(e.key==='c'||e.key==='C')setState('circle');
    if(e.key==='h'||e.key==='H'){setState('wave');sWave();}
    if(e.key==='b'||e.key==='B')setState('bow');
  }
});
document.addEventListener('keyup',e=>{K[e.key]=false;});

[['mbu','ArrowUp'],['mbd','ArrowDown'],['mbl','ArrowLeft'],['mbr','ArrowRight']].forEach(([id,k])=>{
  const el=document.getElementById(id);if(!el)return;
  el.addEventListener('touchstart',ev=>{K[k]=true;ev.preventDefault();},{passive:false});
  el.addEventListener('touchend',ev=>{K[k]=false;ev.preventDefault();},{passive:false});
  el.addEventListener('mousedown',()=>K[k]=true);el.addEventListener('mouseup',()=>K[k]=false);
});

let tID=null,tOrig=null;
document.getElementById('gc').addEventListener('touchstart',e=>{
  e.preventDefault();initAudio();const t=e.changedTouches[0];tID=t.identifier;tOrig={x:t.clientX,y:t.clientY};
},{passive:false});
document.getElementById('gc').addEventListener('touchmove',e=>{
  e.preventDefault();for(const t of e.changedTouches){if(t.identifier!==tID)continue;const dx=t.clientX-tOrig.x,dy=t.clientY-tOrig.y;const mag=Math.hypot(dx,dy);if(mag>22){TD.x=-dy/mag;TD.z=dx/mag;}}
},{passive:false});
document.getElementById('gc').addEventListener('touchend',e=>{e.preventDefault();TD.x=0;TD.z=0;tID=null;tOrig=null;},{passive:false});
</script>
</body>
</html>
